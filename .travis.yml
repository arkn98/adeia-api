stages:
  - name: build-and-test
    if: tag IS blank

  - name: deploy-docs
    if: tag IS present

jobs:
  fast_finish: true

  allow_failures:
    - env: JOB=test-coverage

  include:
    - stage: build-and-test
      language: go
      go:
        - 1.15.x
      os:
        - linux
        - osx
        - windows
      dist: focal
      cache:
        directories:
          - $GOPATH/pkg/mod
      env:
        matrix:
          - JOB=test
          - JOB=build
      before_script:
        - if [ $TRAVIS_OS_NAME == "windows" ]; then
            chocolatey install make;
          fi
      script:
        - 'if [ "${JOB}" = "test" ]; then make test; fi'
        - 'if [ "${JOB}" = "build" ]; then make build; fi'

    - os: linux
      dist: focal
      env: JOB=test-coverage
      script:
        - make test-coverage

    - stage: deploy-docs
      language: python
      python: 3.8
      os: linux
      dist: focal
      cache:
        directories:
          - .venv
      env: JOB=deploy-docs
      before_install:
        - pip install poetry
      install:
        - poetry config virtualenvs.in-project true
        - poetry install
      script:
        - make docs-build
      deploy:
        provider: pages
        github_token: $GHPAGES_DEPLOY_TOKEN
        keep_history: true
        local_dir: docs-build
        repo: arkn98/adeia
        on:
          tags: true
